{% extends 'simulator/base.html' %}
{% load static %}

{% block title %}WS - PyPSA Surplus Analysis{% endblock %}

{% block extra_css %}
<style>
    .pypsa-container {
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #7f8c8d;
        font-size: 0.9em;
        text-transform: uppercase;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
        height: 500px;
    }
    
    .info-box {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
    }
    
    .error-box {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        color: #721c24;
    }
    
    .success-indicator {
        color: #27ae60;
    }
    
    .warning-indicator {
        color: #f39c12;
    }
</style>
{% endblock %}

{% block content %}
<div class="pypsa-container">
    <h1>‚ö° WS - PyPSA Energy System Analysis</h1>
    <p class="lead">Renewable Energy Surplus & Storage Analysis using PyPSA</p>
    
    {% if error %}
    <div class="error-box">
        <h4>‚ùå Error Running Analysis</h4>
        <p>{{ error }}</p>
        <p><small>Make sure PyPSA is installed: pip install pypsa</small></p>
    </div>
    {% endif %}
    
    {% if results %}
    <div class="info-box">
        <h5>‚úÖ Analysis Complete</h5>
        <p>Data source: <strong>SMARD Real Hourly Profiles</strong> (Feb 2023 - Jan 2024) scaled to match your target electricity demand</p>
        <p>Target Total Demand: <strong>1,003.8 GWh/year</strong> | Time period: 8,760 hours | Storage: 65% charge / 90% discharge</p>
        <p style="font-size: 0.9em; color: #666;">
            <strong>Scaled Generation Data:</strong> 
            Solar={{ results.solar_total_gwh|default:"0"|floatformat:1 }} GWh
            Wind={{ results.wind_total_gwh|default:"0"|floatformat:1 }} GWh
            Biomass={{ results.biomass_total_gwh|default:"0"|floatformat:1 }} GWh
            Hydro={{ results.water_total_gwh|default:"0"|floatformat:1 }} GWh
        </p>
    </div>
    
    <!-- Key Statistics -->
    <h2>üìä Key Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Generation</div>
            <div class="stat-value">{{ results.total_generation_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Total Demand</div>
            <div class="stat-value">{{ results.total_demand_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Renewable Share</div>
            <div class="stat-value {% if results.renewable_share_percent >= 100 %}success-indicator{% else %}warning-indicator{% endif %}">
                {{ results.renewable_share_percent|floatformat:1 }}%
            </div>
            <div class="stat-label">of Total Demand</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Total Surplus</div>
            <div class="stat-value success-indicator">{{ results.total_surplus_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
    </div>
    
    <!-- Storage Statistics -->
    <h2>üîã Storage Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Energy Charged</div>
            <div class="stat-value">{{ results.storage_charging_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh/year (into storage)</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Energy Discharged</div>
            <div class="stat-value">{{ results.storage_discharging_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh/year (from storage)</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Max Storage Level</div>
            <div class="stat-value">{{ results.max_storage_level_gwh|floatformat:0 }}</div>
            <div class="stat-label">GWh (peak capacity needed)</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Storage Efficiency</div>
            <div class="stat-value">65% / 90%</div>
            <div class="stat-label">Charge / Discharge</div>
        </div>
    </div>
    
    <!-- Generation Breakdown -->
    <h2>‚ö° Generation Breakdown</h2>
    <div class="stats-grid">
        {% if results.solar_total_gwh %}
        <div class="stat-card">
            <div class="stat-label">‚òÄÔ∏è Solar</div>
            <div class="stat-value">{{ results.solar_total_gwh|floatformat:1 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        {% endif %}
        
        {% if results.wind_total_gwh %}
        <div class="stat-card">
            <div class="stat-label">üí® Wind</div>
            <div class="stat-value">{{ results.wind_total_gwh|floatformat:1 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        {% endif %}
        
        {% if results.biomass_total_gwh %}
        <div class="stat-card">
            <div class="stat-label">üå± Biomass</div>
            <div class="stat-value">{{ results.biomass_total_gwh|floatformat:1 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        {% endif %}
        
        {% if results.water_total_gwh %}
        <div class="stat-card">
            <div class="stat-label">üíß Hydro/Water</div>
            <div class="stat-value">{{ results.water_total_gwh|floatformat:1 }}</div>
            <div class="stat-label">GWh/year</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Time Series Chart -->
    <h2>üìà Energy Flow Diagram</h2>
    <div class="chart-container" style="height: 600px;">
        <canvas id="sankeyChart"></canvas>
    </div>
    
    <!-- Hourly Pattern -->
    <h2>üìä Hourly Energy Flow</h2>
    <div class="chart-container">
        <canvas id="energyFlowChart"></canvas>
    </div>
    
    <!-- Surplus Chart -->
    <h2>‚ö° Surplus Energy Profile</h2>
    <div class="chart-container">
        <canvas id="surplusChart"></canvas>
    </div>
    
    {% endif %}
</div>

{% if results %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // English number formatting function
    function formatNumber(num, decimals = 0) {
        if (num === null || num === undefined || isNaN(num)) return '0';
        return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Get totals for flow diagram
    const solarTotal = parseFloat({{ results.solar_total_gwh|default:0 }});
    const windTotal = parseFloat({{ results.wind_total_gwh|default:0 }});
    const biomassTotal = parseFloat({{ results.biomass_total_gwh|default:0 }});
    const waterTotal = parseFloat({{ results.water_total_gwh|default:0 }});
    const demandTotal = parseFloat({{ results.total_demand_gwh|default:0 }});
    const surplusTotal = parseFloat({{ results.total_surplus_gwh|default:0 }});
    const storageCharged = parseFloat({{ results.storage_charging_gwh|default:0 }});
    const storageDischarged = parseFloat({{ results.storage_discharging_gwh|default:0 }});
    
    // Format all stat values on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Format all stat-value divs
        document.querySelectorAll('.stat-value').forEach(function(el) {
            const text = el.textContent.trim();
            // Check if it's a percentage
            if (text.includes('%')) {
                const num = parseFloat(text.replace('%', '').replace(',', '.'));
                if (!isNaN(num)) {
                    el.textContent = formatNumber(num, 1) + '%';
                }
            } else if (text.includes('/')) {
                // Skip efficiency values like "65% / 90%"
                return;
            } else {
                // Regular numbers
                const num = parseFloat(text.replace(',', '.'));
                if (!isNaN(num)) {
                    el.textContent = formatNumber(num, text.includes('.') ? 1 : 0);
                }
            }
        });
        
        // Format inline numbers in info-box
        const infoTexts = document.querySelectorAll('.info-box p');
        infoTexts.forEach(function(p) {
            let html = p.innerHTML;
            // Replace German number format with English
            html = html.replace(/(\d+),(\d+)/g, '$1.$2'); // Replace comma with period for decimals
            html = html.replace(/(\d)\.(\d{3})\s/g, function(match, p1, p2) {
                // Format thousands
                return formatNumber(parseFloat(p1 + p2), 1) + ' ';
            });
            p.innerHTML = html;
        });
    });
    
    console.log('Solar:', solarTotal, 'Wind:', windTotal, 'Biomass:', biomassTotal, 'Water:', waterTotal);
    console.log('Demand:', demandTotal, 'Surplus:', surplusTotal);
    
    // Prepare timeseries data (already sampled server-side)
    const timestamps = {{ results.timestamps|safe }};
    const generation = {{ results.generation_timeseries|safe }};
    const demand = {{ results.demand_timeseries|safe }};
    const surplus = {{ results.surplus_timeseries|safe }};
    
    console.log('Timestamps length:', timestamps.length);
    console.log('Generation length:', generation.length);
    console.log('First timestamp:', timestamps[0]);
    console.log('First generation:', generation[0]);
    
    // Create Energy Flow Stacked Bar Chart
    const ctxSankey = document.getElementById('sankeyChart').getContext('2d');
    new Chart(ctxSankey, {
        type: 'bar',
        data: {
            labels: ['Generation Sources', 'Storage', 'Consumption'],
            datasets: [
                {
                    label: 'Solar',
                    data: [solarTotal, null, null],
                    backgroundColor: '#f39c12'
                },
                {
                    label: 'Wind',
                    data: [windTotal, null, null],
                    backgroundColor: '#3498db'
                },
                {
                    label: 'Biomass',
                    data: [biomassTotal, null, null],
                    backgroundColor: '#27ae60'
                },
                {
                    label: 'Hydro',
                    data: [waterTotal, null, null],
                    backgroundColor: '#1abc9c'
                },
                {
                    label: 'Storage Charged',
                    data: [null, storageCharged, null],
                    backgroundColor: '#9b59b6'
                },
                {
                    label: 'Storage Discharged',
                    data: [null, storageDischarged, null],
                    backgroundColor: '#8e44ad'
                },
                {
                    label: 'Demand Met',
                    data: [null, null, demandTotal],
                    backgroundColor: '#e74c3c'
                },
                {
                    label: 'Surplus',
                    data: [null, null, surplusTotal],
                    backgroundColor: '#16a085'
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Annual Energy Flow Diagram (GWh/year)',
                    font: {size: 16}
                },
                legend: {
                    position: 'right'
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Energy (GWh/year)'
                    }
                },
                y: {
                    stacked: true
                }
            }
        }
    });
    
    // Energy Flow Chart (Line chart showing generation vs demand over time)
    const ctx1 = document.getElementById('energyFlowChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: sampledTimestamps,
            datasets: [
                {
                    label: 'Generation (GWh/h)',
                    data: sampledGeneration,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 2,
                    fill: true
                },
                {
                    label: 'Demand (GWh/h)',
                    data: sampledDemand,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 2,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Generation vs Demand (Daily Average)'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Energy (GWh/h)'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Surplus Chart
    const ctx2 = document.getElementById('surplusChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: sampledTimestamps,
            datasets: [{
                label: 'Surplus Energy (GWh/h)',
                data: sampledSurplus,
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Surplus Energy Pattern'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Surplus (GWh/h)'
                    },
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
